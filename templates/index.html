<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBERTARIAN 2.0</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="main-container">
        <!-- Brand Header -->
        <div class="brand-header">
            <h1>LIBERTARIAN 2.0</h1>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="feeds">üì∞ FEEDS</button>
            <button class="tab-button" data-tab="favorites">‚ù§Ô∏è READ LATER</button>
            <button class="tab-button" data-tab="saved">üíæ SAVED</button>
            <button class="tab-button" data-tab="config">‚öôÔ∏è CONFIG</button>
        </div>        
        
        <!-- FEEDS TAB -->
        <div id="feeds-tab" class="tab-panel active">
            <div class="feeds-status">
                <span id="feeds-count">Cargando feeds...</span>
                <button onclick="refreshFeeds()" class="refresh-button">üîÑ ACTUALIZAR</button>
            </div>
                        
            {{if .ImportMessage}}
            <div class="import-success-message">
                ‚úÖ ¬°Importaci√≥n exitosa! Se agregaron {{.ImportMessage}} feeds RSS.
            </div>
            <br>
            {{end}}
            
            <div id="feeds-list">
                {{range .Articles}}
                <div class="article-container">
                    <div class="article-line" onclick="toggleArticleContent(this, '{{.Link}}')">
                        <span class="article-date">{{.Date}}</span>
                        <span class="article-source">{{.Source}}</span>
                        <span class="article-title">{{.Title}}</span>
                        <button type="button" class="save-button {{if .IsFav}}saved{{end}}" 
                            data-title="{{.Title}}" data-link="{{.Link}}" data-date="{{.Date}}" 
                            data-source="{{.Source}}" data-description="{{.Description}}"
                            onclick="event.stopPropagation(); toggleFavorite(this)">
                            {{if .IsFav}}SAVED{{else}}SAVE{{end}}
                        </button>
                    </div>
                    <div class="article-content" style="display: none;">
                        <div class="expanded-content">
                            <div class="expanded-meta">
                                <span class="meta-source">{{.Source}}</span>
                                <span class="meta-date">{{.Date}}</span>
                                <div class="action-buttons">
                                    <button type="button" class="action-save {{if .IsFav}}saved{{end}}" 
                                        data-title="{{.Title}}" data-link="{{.Link}}" data-date="{{.Date}}" 
                                        data-source="{{.Source}}"
                                        onclick="toggleFavoriteExpanded(this)">
                                        {{if .IsFav}}SAVED{{else}}SAVE{{end}}
                                    </button>
                                    <button type="button" class="action-like" onclick="likeArticle(this)">
                                        LIKE
                                    </button>
                                    <button type="button" class="action-share" onclick="shareArticle('{{.Link}}')">
                                        SHARE
                                    </button>
                                </div>
                            </div>
                            <div class="article-description">
                                {{.Description}}
                            </div>
                            <a href="{{.Link}}" target="_blank" class="read-original">LEER ORIGINAL</a>
                        </div>
                    </div>
                </div>
                {{else}}
                <p class="no-items">NO HAY ART√çCULOS.</p>
                {{end}}
            </div>
        </div>        
        
        <!-- FAVORITES TAB -->
        <div id="favorites-tab" class="tab-panel">
            <div class="tab-header">
                <h2>‚ù§Ô∏è READ LATER</h2>
                <p class="tab-description">Art√≠culos marcados para leer m√°s tarde</p>
            </div>
            <div id="favorites-list">
                <p class="loading-message">Cargando art√≠culos para leer...</p>
            </div>
        </div>
        
        <!-- SAVED TAB -->
        <div id="saved-tab" class="tab-panel">
            <div class="tab-header">
                <h2>üíæ SAVED</h2>
                <p class="tab-description">Art√≠culos guardados permanentemente</p>
            </div>
            <div id="saved-list">
                <p class="loading-message">Cargando art√≠culos guardados...</p>
            </div>
        </div>
        
        <!-- CONFIG TAB -->
        <div id="config-tab" class="tab-panel">
            <div class="tab-header">
                <h2>‚öôÔ∏è CONFIGURACI√ìN & GESTI√ìN</h2>
            </div>
            
            <div class="config-section">
                <h3>üì• IMPORTAR FEEDS</h3>
                <div class="import-section">
                    <form id="opml-upload-form" enctype="multipart/form-data">
                        <div class="upload-area">
                            <input type="file" id="opml-file" name="opml" accept=".opml,.xml" style="display: none;">
                            <button type="button" onclick="document.getElementById('opml-file').click()" class="upload-button">
                                üìÅ SELECCIONAR ARCHIVO OPML
                            </button>
                            <span id="file-name" class="file-name"></span>
                        </div>
                        <button type="submit" class="import-button">üì• IMPORTAR FEEDS</button>
                    </form>
                    
                    <div class="manual-add">
                        <h4>‚ûï AGREGAR FEED INDIVIDUAL</h4>
                        <form id="manual-feed-form">
                            <input type="url" id="feed-url" placeholder="https://ejemplo.com/rss.xml" required>
                            <button type="submit">AGREGAR</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h3>üìã GESTI√ìN DE FEEDS</h3>
                <div class="feeds-management">
                    <div class="feeds-stats">
                        <span id="total-feeds">Total: --</span>
                        <span id="active-feeds">Activos: --</span>
                    </div>
                    <div class="management-actions">
                        <button onclick="exportFeeds()" class="export-button">üì§ EXPORTAR OPML</button>
                        <button onclick="clearCache()" class="clear-cache-button">üóëÔ∏è LIMPIAR CACHE</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Keyboard shortcuts help -->
        <div class="keyboard-shortcuts-help">
            <button onclick="toggleShortcuts()" class="shortcuts-toggle">‚å®Ô∏è ATAJOS</button>
            <div id="shortcuts-content" style="display: none;">
                <div class="shortcuts-grid">
                    <div><kbd>F</kbd> - Pesta√±a Feeds</div>
                    <div><kbd>V</kbd> - Read Later</div>
                    <div><kbd>S</kbd> - Saved</div>
                    <div><kbd>C</kbd> - Config</div>
                    <div><kbd>R</kbd> - Actualizar feeds</div>
                    <div><kbd>N</kbd> - Nuevo feed</div>
                    <div><kbd>E</kbd> - Expandir art√≠culo</div>
                    <div><kbd>Space</kbd> - Marcar favorito</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentArticles = [];
        let currentFavorites = [];
        let currentSaved = [];
        let activeTab = 'feeds';
        
        // Tab Management
        function switchTab(tabName) {
            activeTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            switch(tabName) {
                case 'feeds':
                    loadFeedsIfNeeded();
                    break;
                case 'favorites':
                    loadFavorites();
                    break;
                case 'saved':
                    loadSaved();
                    break;
                case 'config':
                    loadConfig();
                    break;
            }
        }
        
        // Initialize tab system
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });
            
            initializeForms();
            updateFeedsCount();
            setupKeyboardShortcuts();
        });
        
        function loadFeedsIfNeeded() {
            updateFeedsCount();
        }
        
        function refreshFeeds() {
            const button = document.querySelector('.refresh-button');
            button.textContent = 'üîÑ ACTUALIZANDO...';
            button.disabled = true;
            window.location.reload();
        }
        
        function updateFeedsCount() {
            const articles = document.querySelectorAll('#feeds-list .article-container');
            const count = articles.length;
            document.getElementById('feeds-count').textContent = `${count} art√≠culos cargados`;
        }
        
        async function loadFavorites() {
            const container = document.getElementById('favorites-list');
            try {
                const response = await fetch('/api/favorites');
                const favorites = await response.json();
                
                if (favorites.length === 0) {
                    container.innerHTML = '<p class="no-items">NO HAY FAVORITOS A√öN.</p>';
                    return;
                }
                
                let html = '';
                favorites.forEach(fav => {
                    html += `
                        <div class="article-container">
                            <div class="article-line">
                                <span class="article-date">${fav.Date}</span>
                                <span class="article-source">${fav.Source}</span>
                                <span class="article-title"><a href="${fav.Link}" target="_blank">${fav.Title}</a></span>
                                <button type="button" class="save-button saved" onclick="removeFavorite('${fav.Link}')">SAVED</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p class="error-message">Error cargando favoritos.</p>';
            }
        }
        
        function loadSaved() {
            loadFavorites().then(() => {
                const savedContainer = document.getElementById('saved-list');
                const favoritesHtml = document.getElementById('favorites-list').innerHTML;
                savedContainer.innerHTML = favoritesHtml.replace(/favoritos/g, 'art√≠culos guardados');
            });
        }
        
        function loadConfig() {
            fetch('/api/stats').then(response => response.json()).then(stats => {
                document.getElementById('total-feeds').textContent = `Total: ${stats.totalFeeds}`;
                document.getElementById('active-feeds').textContent = `Activos: ${stats.activeFeeds}`;
            }).catch(() => {
                document.getElementById('total-feeds').textContent = 'Total: --';
                document.getElementById('active-feeds').textContent = 'Activos: --';
            });
        }
        
        function initializeForms() {
            const opmlForm = document.getElementById('opml-upload-form');
            const fileInput = document.getElementById('opml-file');
            const fileName = document.getElementById('file-name');
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        fileName.textContent = this.files[0].name;
                    } else {
                        fileName.textContent = '';
                    }
                });
            }
            
            if (opmlForm) {
                opmlForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!fileInput.files.length) {
                        alert('Por favor selecciona un archivo OPML');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('opml', fileInput.files[0]);
                    
                    try {
                        const response = await fetch('/add', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            alert('¬°Feeds importados exitosamente!');
                            switchTab('feeds');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            alert('Error al importar feeds');
                        }
                    } catch (error) {
                        alert('Error al importar feeds');
                    }
                });
            }
            
            const manualForm = document.getElementById('manual-feed-form');
            if (manualForm) {
                manualForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const feedUrl = document.getElementById('feed-url').value;
                    const formData = new FormData();
                    formData.append('feed_url', feedUrl);
                    
                    try {
                        const response = await fetch('/add', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            alert('¬°Feed agregado exitosamente!');
                            document.getElementById('feed-url').value = '';
                            switchTab('feeds');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            const text = await response.text();
                            alert('Error: ' + text);
                        }
                    } catch (error) {
                        alert('Error al agregar feed');
                    }
                });
            }
        }
        
        function exportFeeds() {
            window.open('/export-opml', '_blank');
        }
        
        function clearCache() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el cache?')) {
                fetch('/api/clear-cache', { method: 'POST' })
                    .then(() => {
                        alert('Cache limpiado exitosamente');
                        refreshFeeds();
                    })
                    .catch(() => alert('Error al limpiar cache'));
            }
        }
        
        async function removeFavorite(link) {
            try {
                const formData = new FormData();
                formData.append('link', link);
                
                const response = await fetch('/favorite', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    loadFavorites();
                }
            } catch (error) {
                console.error('Error removing favorite:', error);
            }
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case 'f':
                        e.preventDefault();
                        switchTab('feeds');
                        break;
                    case 'v':
                        e.preventDefault();
                        switchTab('favorites');
                        break;
                    case 's':
                        e.preventDefault();
                        switchTab('saved');
                        break;
                    case 'c':
                        e.preventDefault();
                        switchTab('config');
                        break;
                    case 'r':
                        if (activeTab === 'feeds') {
                            e.preventDefault();
                            refreshFeeds();
                        }
                        break;
                    case 'n':
                        e.preventDefault();
                        switchTab('config');
                        setTimeout(() => {
                            const feedInput = document.getElementById('feed-url');
                            if (feedInput) feedInput.focus();
                        }, 100);
                        break;
                    case '?':
                        e.preventDefault();
                        toggleShortcuts();
                        break;
                }
            });
        }
        
        // Article functions
        async function toggleFavorite(button) {
            const title = button.getAttribute('data-title');
            const link = button.getAttribute('data-link');
            const date = button.getAttribute('data-date');
            const source = button.getAttribute('data-source');
            
            const formData = new FormData();
            formData.append('title', title);
            formData.append('link', link);
            formData.append('date', date);
            formData.append('source', source);
            
            try {
                const response = await fetch('/favorite', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.text();
                    if (result === 'added') {
                        button.textContent = 'SAVED';
                        button.classList.add('saved');
                    } else {
                        button.textContent = 'SAVE';
                        button.classList.remove('saved');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function toggleFavoriteExpanded(button) {
            await toggleFavorite(button);
            // Sync with the main line button
            const container = button.closest('.article-container');
            const mainButton = container.querySelector('.article-line .save-button');
            if (button.classList.contains('saved')) {
                mainButton.textContent = 'SAVED';
                mainButton.classList.add('saved');
            } else {
                mainButton.textContent = 'SAVE';
                mainButton.classList.remove('saved');
            }
        }
        
        function likeArticle(button) {
            if (button.textContent === 'LIKE') {
                button.textContent = 'LIKED';
                button.classList.add('liked');
            } else {
                button.textContent = 'LIKE';
                button.classList.remove('liked');
            }
        }
        
        function shareArticle(url) {
            if (navigator.share) {
                navigator.share({
                    title: 'Art√≠culo interesante',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('URL copiada al portapapeles');
                });
            }
        }
        
        async function toggleArticleContent(element, url) {
            const container = element.parentElement;
            const content = container.querySelector('.article-content');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }
        
        function toggleShortcuts() {
            const content = document.getElementById('shortcuts-content');
            const button = document.querySelector('.shortcuts-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '‚å®Ô∏è OCULTAR ATAJOS';
            } else {
                content.style.display = 'none';
                button.textContent = '‚å®Ô∏è ATAJOS';
            }
        }
    </script>
</body>
</html>
