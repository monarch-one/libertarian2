<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBERTARIAN 2.0</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="main-container">
        <!-- Brand Header -->
        <div class="brand-header">
            <h1>LIBERTARIAN 2.0</h1>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="feeds">üì∞ FEEDS</button>
            <button class="tab-button" data-tab="favorites">‚ù§Ô∏è READ LATER</button>
            <button class="tab-button" data-tab="saved">üíæ SAVED</button>
            <button class="tab-button" data-tab="config">‚öôÔ∏è CONFIG</button>
        </div>        
        
        <!-- FEEDS TAB -->
        <div id="feeds-tab" class="tab-panel active">
            <div class="feeds-status">
                <span id="feeds-count">Loading feeds...</span>
                <button onclick="refreshFeeds()" class="refresh-button">üîÑ ACTUALIZAR</button>
            </div>
                        
            {{if .ImportMessage}}
            <div class="import-success-message">
                ‚úÖ ¬°Importaci√≥n exitosa! Se agregaron {{.ImportMessage}} feeds RSS.
            </div>
            <br>
            {{end}}
            
            <div id="feeds-list">
                {{range .Articles}}
                <div class="article-container">
                    <div class="article-line" onclick="toggleArticleContent(this, '{{.Link}}')">
                        <span class="article-date">{{.Date}}</span>
                        <span class="article-source">{{.Source}}</span>
                        <span class="article-title">{{.Title}}</span>
                        <button type="button" class="save-button {{if .IsFav}}saved{{end}}" 
                            data-title="{{.Title}}" data-link="{{.Link}}" data-date="{{.Date}}" 
                            data-source="{{.Source}}" data-description="{{.Description}}"
                            onclick="event.stopPropagation(); toggleFavorite(this)">
                            {{if .IsFav}}SAVED{{else}}SAVE{{end}}
                        </button>
                    </div>
                    <div class="article-content" style="display: none;">
                        <div class="expanded-content">
                            <div class="expanded-meta">
                                <span class="meta-source">{{.Source}}</span>
                                <span class="meta-date">{{.Date}}</span>
                                <div class="action-buttons">
                                    <button type="button" class="action-save {{if .IsFav}}saved{{end}}" 
                                        data-title="{{.Title}}" data-link="{{.Link}}" data-date="{{.Date}}" 
                                        data-source="{{.Source}}"
                                        onclick="toggleFavoriteExpanded(this)">
                                        {{if .IsFav}}SAVED{{else}}SAVE{{end}}
                                    </button>
                                    <button type="button" class="action-like" onclick="likeArticle(this)">
                                        LIKE
                                    </button>
                                    <button type="button" class="action-share" onclick="shareArticle('{{.Link}}')">
                                        SHARE
                                    </button>
                                </div>
                            </div>
                            <div class="article-description">
                                {{.Description}}
                            </div>
                            <a href="{{.Link}}" target="_blank" class="read-original">LEER ORIGINAL</a>
                        </div>
                    </div>
                </div>
                {{else}}
                <p class="no-items">NO HAY ART√çCULOS.</p>
                {{end}}
            </div>
        </div>        
        
        <!-- FAVORITES TAB -->
        <div id="favorites-tab" class="tab-panel">
            <div class="tab-header">
                <h2>‚ù§Ô∏è READ LATER</h2>
                <p class="tab-description">Art√≠culos marcados para leer m√°s tarde</p>
            </div>
            <div id="favorites-list">
                <p class="loading-message">Loading articles to read...</p>
            </div>
        </div>
        
        <!-- SAVED TAB -->
        <div id="saved-tab" class="tab-panel">
            <div class="tab-header">
                <h2>üíæ SAVED</h2>
                <p class="tab-description">Art√≠culos guardados permanentemente</p>
            </div>
            <div id="saved-list">
                <p class="loading-message">Loading saved articles...</p>
            </div>
        </div>
        
        <!-- CONFIG TAB -->
        <div id="config-tab" class="tab-panel">
            <div class="tab-header">
                <h2>‚öôÔ∏è CONFIGURATION & MANAGEMENT</h2>
            </div>
            
            <div class="config-section">
                <h3>üì• IMPORT FEEDS</h3>
                <div class="import-section">
                    <form id="opml-upload-form" enctype="multipart/form-data">
                        <div class="upload-area">
                            <input type="file" id="opml-file" name="opml" accept=".opml,.xml" style="display: none;">
                            <button type="button" onclick="document.getElementById('opml-file').click()" class="upload-button">
                                üìÅ SELECT OPML FILE
                            </button>
                            <span id="file-name" class="file-name"></span>
                        </div>
                        <button type="submit" class="import-button">üì• IMPORT FEEDS</button>
                    </form>
                    
                    <div class="manual-add">
                        <h4>‚ûï ADD INDIVIDUAL FEED</h4>
                        <form id="manual-feed-form">
                            <input type="url" id="feed-url" placeholder="https://example.com/rss.xml" required>
                            <button type="submit">ADD FEED</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="config-section">
                <h3>üìã FEED MANAGEMENT</h3>
                <div class="feeds-management">
                    <div class="feeds-stats">
                        <span id="total-feeds">Total: --</span>
                        <span id="active-feeds">Activos: --</span>
                    </div>
                    <div class="management-actions">
                        <button onclick="exportFeeds()" class="export-button">üì§ EXPORTAR OPML</button>
                        <button onclick="clearCache()" class="clear-cache-button">üóëÔ∏è LIMPIAR CACHE</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Keyboard shortcuts help -->
        <div class="keyboard-shortcuts-help">
            <button onclick="toggleShortcuts()" class="shortcuts-toggle">‚å®Ô∏è ATAJOS</button>
            <div id="shortcuts-content" style="display: none;">
                <div class="shortcuts-grid">
                    <div><kbd>F</kbd> - Pesta√±a Feeds</div>
                    <div><kbd>V</kbd> - Read Later</div>
                    <div><kbd>S</kbd> - Saved</div>
                    <div><kbd>C</kbd> - Config</div>
                    <div><kbd>R</kbd> - Actualizar feeds</div>
                    <div><kbd>N</kbd> - Nuevo feed</div>
                    <div><kbd>E</kbd> - Expandir art√≠culo</div>
                    <div><kbd>Space</kbd> - Marcar favorito</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentArticles = [];
        let currentFavorites = [];
        let currentSaved = [];
        let activeTab = 'feeds';
        let currentOpenArticle = null; // Para rastrear el art√≠culo actualmente abierto
        let currentSelectedIndex = -1; // Para navegaci√≥n por teclado
        
        // Tab Management
        function switchTab(tabName) {
            activeTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            switch(tabName) {
                case 'feeds':
                    loadFeedsIfNeeded();
                    break;
                case 'favorites':
                    loadFavorites();
                    break;
                case 'saved':
                    loadSaved();
                    break;
                case 'config':
                    loadConfig();
                    break;
            }
        }
        
        // Initialize tab system
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });
            
            initializeForms();
            updateFeedsCount();
            setupKeyboardShortcuts();
        });
        
        function loadFeedsIfNeeded() {
            updateFeedsCount();
        }
        
        function refreshFeeds() {
            const button = document.querySelector('.refresh-button');
            button.textContent = 'üîÑ ACTUALIZANDO...';
            button.disabled = true;
            window.location.reload();
        }
        
        function updateFeedsCount() {
            const articles = document.querySelectorAll('#feeds-list .article-container');
            const count = articles.length;
            document.getElementById('feeds-count').textContent = `${count} art√≠culos cargados`;
        }
        
        async function loadFavorites() {
            const container = document.getElementById('favorites-list');
            try {
                const response = await fetch('/api/favorites');
                const favorites = await response.json();
                
                if (favorites.length === 0) {
                    container.innerHTML = '<p class="no-items">NO HAY FAVORITOS A√öN.</p>';
                    return;
                }
                
                let html = '';
                favorites.forEach(fav => {
                    html += `
                        <div class="article-container">
                            <div class="article-line" onclick="toggleArticleContent(this, '${fav.Link}')">
                                <span class="article-date">${fav.Date}</span>
                                <span class="article-source">${fav.Source}</span>
                                <span class="article-title">${fav.Title}</span>
                                <button type="button" class="save-button saved" 
                                    data-title="${fav.Title}" data-link="${fav.Link}" data-date="${fav.Date}" 
                                    data-source="${fav.Source}" 
                                    onclick="event.stopPropagation(); removeFavorite('${fav.Link}')">SAVED</button>
                            </div>
                            <div class="article-content" style="display: none;">
                                <div class="expanded-meta">
                                    <span class="meta-date">${fav.Date}</span>
                                    <span class="meta-source">${fav.Source}</span>
                                </div>
                                <div class="action-buttons">
                                    <button type="button" class="action-save saved" onclick="removeFavorite('${fav.Link}')">SAVED</button>
                                    <a href="${fav.Link}" target="_blank" class="read-original">üîó LEER ORIGINAL</a>
                                </div>
                                <div class="article-description">${fav.Description || 'No hay descripci√≥n disponible.'}</div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                
                // Resetear navegaci√≥n cuando se cargan los favoritos
                currentSelectedIndex = -1;
                currentOpenArticle = null;
                
            } catch (error) {
                container.innerHTML = '<p class="error-message">Error loading favorites.</p>';
            }
        }
        
        function loadSaved() {
            // Usar la misma l√≥gica que loadFavorites para consistencia
            loadFavorites().then(() => {
                const savedContainer = document.getElementById('saved-list');
                const favoritesContainer = document.getElementById('favorites-list');
                savedContainer.innerHTML = favoritesContainer.innerHTML;
                
                // Resetear navegaci√≥n cuando se cargan los guardados
                currentSelectedIndex = -1;
                currentOpenArticle = null;
            });
        }
        
        function extractChannelName(url) {
            try {
                // Para YouTube
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    if (url.includes('/channel/')) {
                        const channelId = url.match(/\/channel\/([^\/\?]+)/);
                        return channelId ? `YouTube Channel ${channelId[1].substring(0, 8)}...` : 'YouTube Channel';
                    } else if (url.includes('/feeds/videos.xml?channel_id=')) {
                        const channelId = url.match(/channel_id=([^&]+)/);
                        return channelId ? `YouTube Channel ${channelId[1].substring(0, 8)}...` : 'YouTube Channel';
                    } else if (url.includes('/feeds/videos.xml?user=')) {
                        const username = url.match(/user=([^&]+)/);
                        return username ? `YouTube @${username[1]}` : 'YouTube Channel';
                    }
                    return 'YouTube Channel';
                }
                
                // Para otros sitios, extraer dominio
                const urlObj = new URL(url);
                let domain = urlObj.hostname.replace('www.', '');
                
                // Casos especiales conocidos
                if (domain.includes('reddit.com')) return 'Reddit';
                if (domain.includes('github.com')) return 'GitHub';
                if (domain.includes('medium.com')) return 'Medium';
                if (domain.includes('dev.to')) return 'Dev.to';
                if (domain.includes('hackernews')) return 'Hacker News';
                
                // Capitalizar primera letra del dominio
                domain = domain.split('.')[0];
                return domain.charAt(0).toUpperCase() + domain.slice(1);
                
            } catch (e) {
                return 'Unknown Source';
            }
        }
        
        function loadConfig() {
            // Load stats
            fetch('/api/stats').then(response => response.json()).then(stats => {
                document.getElementById('total-feeds').textContent = `Total: ${stats.totalFeeds}`;
                document.getElementById('active-feeds').textContent = `Active: ${stats.activeFeeds}`;
            }).catch(() => {
                document.getElementById('total-feeds').textContent = 'Total: --';
                document.getElementById('active-feeds').textContent = 'Active: --';
            });
            
            // Load and display feeds list automatically
            loadFeedsList();
        }
        
        function loadFeedsList() {
            const feedsList = document.getElementById('feeds-list-config');
            if (!feedsList) {
                // Create feeds list section if it doesn't exist
                const configSection = document.querySelector('.feeds-management');
                if (configSection) {
                    const feedsListHTML = `
                        <div id="feeds-list-config" style="margin-top: 20px;">
                            <h4>üìÇ CURRENT FEEDS</h4>
                            <div id="feeds-content-config" style="max-height: 300px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: #111;">
                                Loading feeds...
                            </div>
                        </div>
                    `;
                    configSection.insertAdjacentHTML('beforeend', feedsListHTML);
                }
            }
            
            // Load feeds data
            fetch('/api/feeds')
                .then(response => response.json())
                .then(feeds => {
                    const feedsContent = document.getElementById('feeds-content-config');
                    if (feedsContent) {
                        let html = '';
                        
                        // Separar feeds problem√°ticos y activos
                        const brokenFeeds = feeds.filter(feed => !feed.Active);
                        const workingFeeds = feeds.filter(feed => feed.Active);
                        
                        // Mostrar feeds problem√°ticos primero en rojo
                        if (brokenFeeds.length > 0) {
                            html += '<div style="margin-bottom: 15px;"><div style="color: #ff4444; font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è PROBLEMATIC FEEDS</div>';
                            brokenFeeds.forEach((feed, index) => {
                                const channelName = extractChannelName(feed.URL);
                                html += `
                                    <div style="padding: 8px; border-bottom: 1px solid #333; font-family: 'JetBrains Mono', monospace; font-size: 14px;">
                                        <div style="color: #ff4444;">‚ùå BROKEN - ${channelName}</div>
                                        <div style="color: #888; margin-top: 4px; font-size: 14px;">${feed.URL}</div>
                                    </div>
                                `;
                            });
                            html += '</div>';
                        }
                        
                        // Mostrar feeds activos en verde
                        if (workingFeeds.length > 0) {
                            html += '<div><div style="color: #00aa00; font-weight: bold; margin-bottom: 8px;">‚úÖ WORKING FEEDS</div>';
                            workingFeeds.forEach((feed, index) => {
                                const channelName = extractChannelName(feed.URL);
                                html += `
                                    <div style="padding: 8px; border-bottom: 1px solid #333; font-family: 'JetBrains Mono', monospace; font-size: 14px;">
                                        <div style="color: #00aa00;">‚úÖ ACTIVE - ${channelName}</div>
                                        <div style="color: #888; margin-top: 4px; font-size: 14px;">${feed.URL}</div>
                                    </div>
                                `;
                            });
                            html += '</div>';
                        }
                        
                        feedsContent.innerHTML = html || '<div style="color: #888; font-size: 14px;">No feeds configured</div>';
                    }
                })
                .catch(error => {
                    const feedsContent = document.getElementById('feeds-content-config');
                    if (feedsContent) {
                        feedsContent.innerHTML = '<div style="color: #ff4444;">Error loading feeds</div>';
                    }
                });
        }
        
        function initializeForms() {
            const opmlForm = document.getElementById('opml-upload-form');
            const fileInput = document.getElementById('opml-file');
            const fileName = document.getElementById('file-name');
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        fileName.textContent = this.files[0].name;
                    } else {
                        fileName.textContent = '';
                    }
                });
            }
            
            if (opmlForm) {
                opmlForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!fileInput.files.length) {
                        alert('Por favor selecciona un archivo OPML');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('opml', fileInput.files[0]);
                    
                    try {
                        const response = await fetch('/upload-opml', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            alert('¬°Feeds importados exitosamente!');
                            switchTab('feeds');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            alert('Error al importar feeds');
                        }
                    } catch (error) {
                        alert('Error al importar feeds');
                    }
                });
            }
            
            const manualForm = document.getElementById('manual-feed-form');
            if (manualForm) {
                manualForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const feedUrl = document.getElementById('feed-url').value;
                    const formData = new FormData();
                    formData.append('url', feedUrl);
                    
                    try {
                        const response = await fetch('/add', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            alert('¬°Feed agregado exitosamente!');
                            document.getElementById('feed-url').value = '';
                            switchTab('feeds');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            const text = await response.text();
                            alert('Error: ' + text);
                        }
                    } catch (error) {
                        alert('Error al agregar feed');
                    }
                });
            }
        }
        
        function exportFeeds() {
            window.open('/export-opml', '_blank');
        }
        
        function clearCache() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el cache?')) {
                fetch('/api/clear-cache', { method: 'POST' })
                    .then(() => {
                        alert('Cache limpiado exitosamente');
                        refreshFeeds();
                    })
                    .catch(() => alert('Error al limpiar cache'));
            }
        }
        
        async function removeFavorite(link) {
            try {
                const formData = new FormData();
                formData.append('link', link);
                
                const response = await fetch('/favorite', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    loadFavorites();
                }
            } catch (error) {
                console.error('Error removing favorite:', error);
            }
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case 'f':
                        e.preventDefault();
                        switchTab('feeds');
                        break;
                    case 'v':
                        e.preventDefault();
                        switchTab('favorites');
                        break;
                    case 's':
                        e.preventDefault();
                        switchTab('saved');
                        break;
                    case 'c':
                        e.preventDefault();
                        switchTab('config');
                        break;
                    case 'r':
                        if (activeTab === 'feeds') {
                            e.preventDefault();
                            refreshFeeds();
                        }
                        break;
                    case 'n':
                        e.preventDefault();
                        switchTab('config');
                        setTimeout(() => {
                            const feedInput = document.getElementById('feed-url');
                            if (feedInput) feedInput.focus();
                        }, 100);
                        break;
                    case 'j': // Navegaci√≥n hacia abajo / cerrar art√≠culo
                        e.preventDefault();
                        handleJKeyPress();
                        break;
                    case 'k': // Navegaci√≥n hacia arriba
                        e.preventDefault();
                        handleKKeyPress();
                        break;
                    case 'enter': // Abrir/cerrar art√≠culo
                        e.preventDefault();
                        handleEnterKeyPress();
                        break;
                    case ' ': // Space - marcar favorito
                        e.preventDefault();
                        handleSpaceKeyPress();
                        break;
                    case '?':
                        e.preventDefault();
                        toggleShortcuts();
                        break;
                }
            });
        }
        
        // Funciones de navegaci√≥n por teclado
        function handleJKeyPress() {
            if (currentOpenArticle) {
                // Si hay un art√≠culo abierto, cerrarlo y marcarlo como le√≠do si est√° en favorites/saved
                closeCurrentArticleAndMarkRead();
                navigateToNext();
            } else {
                // Navegar al siguiente art√≠culo
                navigateToNext();
            }
        }
        
        function handleKKeyPress() {
            if (currentOpenArticle) {
                // Si hay un art√≠culo abierto, cerrarlo
                closeCurrentArticle();
            } else {
                // Navegar al art√≠culo anterior
                navigateToPrevious();
            }
        }
        
        function handleEnterKeyPress() {
            const articles = getCurrentTabArticles();
            if (currentSelectedIndex >= 0 && currentSelectedIndex < articles.length) {
                const articleLine = getArticleLineByIndex(currentSelectedIndex);
                if (articleLine) {
                    const url = articleLine.getAttribute('data-url') || articleLine.querySelector('.article-title a')?.href;
                    toggleArticleContent(articleLine, url);
                }
            }
        }
        
        function handleSpaceKeyPress() {
            const articles = getCurrentTabArticles();
            if (currentSelectedIndex >= 0 && currentSelectedIndex < articles.length) {
                const articleLine = getArticleLineByIndex(currentSelectedIndex);
                if (articleLine) {
                    const saveButton = articleLine.querySelector('.save-button');
                    if (saveButton) {
                        saveButton.click();
                    }
                }
            }
        }
        
        function closeCurrentArticleAndMarkRead() {
            if (currentOpenArticle) {
                const content = currentOpenArticle.parentElement.querySelector('.article-content');
                if (content) {
                    content.style.display = 'none';
                }
                
                // Remover clase de art√≠culo seleccionado
                currentOpenArticle.classList.remove('article-selected');
                
                // Si estamos en favorites o saved, marcar como le√≠do (remover de la lista)
                if (activeTab === 'favorites' || activeTab === 'saved') {
                    markArticleAsReadInFavorites(currentOpenArticle);
                }
                
                currentOpenArticle = null;
            }
        }
        
        function closeCurrentArticle() {
            if (currentOpenArticle) {
                const content = currentOpenArticle.parentElement.querySelector('.article-content');
                if (content) {
                    content.style.display = 'none';
                }
                currentOpenArticle.classList.remove('article-selected');
                currentOpenArticle = null;
            }
        }
        
        function navigateToNext() {
            const articles = getCurrentTabArticles();
            if (articles.length === 0) return;
            
            currentSelectedIndex = Math.min(currentSelectedIndex + 1, articles.length - 1);
            updateArticleSelection();
        }
        
        function navigateToPrevious() {
            const articles = getCurrentTabArticles();
            if (articles.length === 0) return;
            
            currentSelectedIndex = Math.max(currentSelectedIndex - 1, 0);
            updateArticleSelection();
        }
        
        function getCurrentTabArticles() {
            let containerId;
            switch(activeTab) {
                case 'feeds': containerId = 'feeds-list'; break;
                case 'favorites': containerId = 'favorites-list'; break;
                case 'saved': containerId = 'saved-list'; break;
                default: return [];
            }
            
            const container = document.getElementById(containerId);
            return container ? Array.from(container.querySelectorAll('.article-line')) : [];
        }
        
        function getArticleLineByIndex(index) {
            const articles = getCurrentTabArticles();
            return articles[index] || null;
        }
        
        function updateArticleSelection() {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.article-line').forEach(line => {
                line.classList.remove('article-selected');
            });
            
            // Agregar selecci√≥n actual
            const currentArticle = getArticleLineByIndex(currentSelectedIndex);
            if (currentArticle) {
                currentArticle.classList.add('article-selected');
                currentArticle.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        function markArticleAsReadInFavorites(articleLine) {
            // Encontrar el link del art√≠culo para removerlo de favoritos
            const titleElement = articleLine.querySelector('.article-title a');
            if (titleElement) {
                const link = titleElement.href;
                removeFavorite(link);
            }
        }
        
        // Article functions
        async function toggleFavorite(button) {
            const title = button.getAttribute('data-title');
            const link = button.getAttribute('data-link');
            const date = button.getAttribute('data-date');
            const source = button.getAttribute('data-source');
            
            const formData = new FormData();
            formData.append('title', title);
            formData.append('link', link);
            formData.append('date', date);
            formData.append('source', source);
            
            try {
                const response = await fetch('/favorite', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.text();
                    if (result === 'added') {
                        button.textContent = 'SAVED';
                        button.classList.add('saved');
                    } else {
                        button.textContent = 'SAVE';
                        button.classList.remove('saved');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function toggleFavoriteExpanded(button) {
            await toggleFavorite(button);
            // Sync with the main line button
            const container = button.closest('.article-container');
            const mainButton = container.querySelector('.article-line .save-button');
            if (button.classList.contains('saved')) {
                mainButton.textContent = 'SAVED';
                mainButton.classList.add('saved');
            } else {
                mainButton.textContent = 'SAVE';
                mainButton.classList.remove('saved');
            }
        }
        
        function likeArticle(button) {
            if (button.textContent === 'LIKE') {
                button.textContent = 'LIKED';
                button.classList.add('liked');
            } else {
                button.textContent = 'LIKE';
                button.classList.remove('liked');
            }
        }
        
        function shareArticle(url) {
            if (navigator.share) {
                navigator.share({
                    title: 'Art√≠culo interesante',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('URL copiada al portapapeles');
                });
            }
        }
        
        async function toggleArticleContent(element, url) {
            const container = element.parentElement;
            const content = container.querySelector('.article-content');
            
            // Si hay otro art√≠culo abierto, cerrarlo primero
            if (currentOpenArticle && currentOpenArticle !== element) {
                const oldContent = currentOpenArticle.parentElement.querySelector('.article-content');
                if (oldContent) {
                    oldContent.style.display = 'none';
                }
                currentOpenArticle.classList.remove('article-selected');
            }
            
            if (content.style.display === 'none' || content.style.display === '') {
                // Abrir art√≠culo
                content.style.display = 'block';
                element.classList.add('article-selected');
                currentOpenArticle = element;
                
                // Actualizar el √≠ndice seleccionado
                const articles = getCurrentTabArticles();
                currentSelectedIndex = articles.indexOf(element);
            } else {
                // Cerrar art√≠culo
                content.style.display = 'none';
                element.classList.remove('article-selected');
                currentOpenArticle = null;
            }
        }
        
        function toggleShortcuts() {
            const content = document.getElementById('shortcuts-content');
            const button = document.querySelector('.shortcuts-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '‚å®Ô∏è OCULTAR ATAJOS';
            } else {
                content.style.display = 'none';
                button.textContent = '‚å®Ô∏è ATAJOS';
            }
        }
    </script>
</body>
</html>
