<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="main-container">
        <div class="header-container">
            <h1>{{.Title}}</h1>
            <div class="feed-actions">
                <a href="/">← VOLVER AL LECTOR</a>
            </div>
        </div>
        <br>

    <div class="article-page-content">
        <!-- Título del artículo -->
        <h2>{{.Title}}</h2>
        
        <!-- Línea con fecha/hora, fuente y SAVE -->
        <div class="article-meta-line">
            <div class="article-datetime-source">
                <span class="article-datetime">{{.Date}}</span>
                <span class="article-source-name">[{{.Source}}]</span>
            </div>
            <button type="button" class="star-button {{if .IsFav}}star-favorite{{end}}" data-title="{{.Title}}"
                data-link="{{.Link}}" data-date="{{.Date}}" data-source="{{.Source}}"
                onclick="toggleFavorite(this)">{{if .IsFav}}SAVED{{else}}SAVE{{end}}</button>
        </div>

        <!-- Imagen del artículo si existe -->
        {{if .ImageURL}}
        <div class="article-image">
            <img src="{{.ImageURL}}" alt="{{.Title}}" onerror="this.style.display='none'">
        </div>
        {{end}}

        <!-- Contenido del artículo -->
        {{if .FullContent}}
        <div class="scraped-content">
            {{.FullContent}}
        </div>
        {{else}}
        <p class="no-content-message">
            No se pudo cargar el contenido completo del artículo automáticamente.
        </p>
        {{end}}
        
        <p class="article-original-link">
            Leer artículo original: <a href="{{.Link}}" target="_blank">{{.Link}}</a>
        </p>

        <!-- Keyboard shortcuts help -->
        <div class="keyboard-shortcuts-help">
            <button class="shortcuts-toggle" onclick="toggleShortcuts()">⌨️ ATAJOS</button>
            <div class="shortcuts-content" id="shortcuts-content" style="display: none;">
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span class="shortcut-key">ESC</span>
                        <span class="shortcut-desc">Volver al lector</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">J</span>
                        <span class="shortcut-desc">Artículo siguiente</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">K</span>
                        <span class="shortcut-desc">Artículo anterior</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">S</span>
                        <span class="shortcut-desc">Guardar/quitar favorito</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">O</span>
                        <span class="shortcut-desc">Abrir original</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">F</span>
                        <span class="shortcut-desc">Ver favoritos</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">N</span>
                        <span class="shortcut-desc">Agregar feed</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">I</span>
                        <span class="shortcut-desc">Importar OPML</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">R</span>
                        <span class="shortcut-desc">Recargar</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function toggleFavorite(button) {
            const title = button.dataset.title;
            const link = button.dataset.link;
            const date = button.dataset.date;
            const source = button.dataset.source;

            const formData = new URLSearchParams();
            formData.append('title', title);
            formData.append('link', link);
            formData.append('date', date);
            formData.append('source', source);

            try {
                const response = await fetch('/favorite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });

                if (response.ok) {
                    if (button.classList.contains('star-favorite')) {
                        button.classList.remove('star-favorite');
                        button.textContent = 'SAVE';
                    } else {
                        button.classList.add('star-favorite');
                        button.textContent = 'SAVED';
                    }
                    console.log('Artículo marcado como favorito/desmarcado.');
                } else {
                    console.error('Error al marcar/desmarcar artículo:', response.statusText);
                }
            } catch (error) {
                console.error('Error de red:', error);
            }
        }

        function toggleShortcuts() {
            const content = document.getElementById('shortcuts-content');
            const button = document.querySelector('.shortcuts-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '⌨️ OCULTAR ATAJOS';
            } else {
                content.style.display = 'none';
                button.textContent = '⌨️ ATAJOS';
            }
        }

        // Keyboard shortcuts similar to ANCAP
        document.addEventListener('keydown', function(e) {
            // Ignore if user is typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            switch(e.key.toLowerCase()) {
                case 'escape':
                    // Use browser back for instant navigation
                    e.preventDefault();
                    window.history.back();
                    break;
                
                case 'h':
                case 'arrowleft':
                    // Use browser back for instant navigation
                    e.preventDefault();
                    window.history.back();
                    break;
                
                case 'f':
                    // Go to favorites
                    window.location.href = '/favorites';
                    break;
                
                case 'n':
                    // Add new feed
                    window.location.href = '/form';
                    break;
                
                case 'i':
                    // Import OPML
                    window.location.href = '/import-opml';
                    break;
                
                case 's':
                    // Save/unsave current article
                    e.preventDefault();
                    const saveButton = document.querySelector('.star-button');
                    if (saveButton) {
                        saveButton.click();
                    }
                    break;
                
                case 'j':
                case 'arrowdown':
                    // Navigate to next article
                    e.preventDefault();
                    navigateToArticle(1);
                    break;
                
                case 'k':
                case 'arrowup':
                    // Navigate to previous article
                    e.preventDefault();
                    navigateToArticle(-1);
                    break;
                
                case 'o':
                    // Open original article
                    e.preventDefault();
                    const originalLink = document.querySelector('.article-original-link a');
                    if (originalLink) {
                        originalLink.click();
                    }
                    break;
                
                case 'r':
                    // Refresh the page
                    window.location.reload();
                    break;
            }
        });

        // Navigation between articles using sessionStorage
        function navigateToArticle(direction) {
            try {
                const articleListStr = sessionStorage.getItem('articleList');
                const currentIndexStr = sessionStorage.getItem('currentArticleIndex');
                
                if (!articleListStr || !currentIndexStr) {
                    console.log('No navigation data found, going back');
                    window.history.back();
                    return;
                }
                
                const articleList = JSON.parse(articleListStr);
                let currentIndex = parseInt(currentIndexStr);
                
                // Calculate new index
                currentIndex += direction;
                
                // Wrap around
                if (currentIndex >= articleList.length) {
                    currentIndex = 0;
                } else if (currentIndex < 0) {
                    currentIndex = articleList.length - 1;
                }
                
                // Update stored index
                sessionStorage.setItem('currentArticleIndex', currentIndex.toString());
                
                // Navigate to the new article
                const nextArticle = articleList[currentIndex];
                if (nextArticle && nextArticle.url) {
                    window.location.href = nextArticle.url;
                } else {
                    console.log('Invalid article data, going back');
                    window.history.back();
                }
            } catch (error) {
                console.error('Error navigating articles:', error);
                window.history.back();
            }
        }
    </script>
    </div> <!-- main-container -->
</body>

</html>